<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ISHAREAI Chat Widget</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100">

  <!-- Chat Widget (Floating) -->
  <div class="fixed bottom-4 right-4 z-50">
    <!-- Circle Avatar -->
    <button id="openChat" class="w-16 h-16 rounded-full shadow-lg bg-white overflow-hidden border border-gray-300 flex items-center justify-center hover:scale-105 transition">
      <img src="img/billpetruck1.jpg" alt="AI Avatar" class="w-full h-full object-cover" />
    </button>

    <!-- Chat Box -->
    <div id="chatBox" class="hidden mt-2 w-80 max-h-[70vh] bg-white rounded-xl shadow-xl flex flex-col overflow-hidden">
      <!-- Header -->
      <div class="flex items-center gap-2 p-4 bg-pink-600 text-white">
        <img src="img/billpetruck1.jpg" alt="Avatar" class="w-10 h-10 rounded-full" />
        <div>
          <div class="font-semibold">ISHAREAI</div>
          <div class="text-sm opacity-80">Hi, i'am Bill , your AI Assistant</div>
        </div>
        <button id="closeChat" class="ml-auto text-white hover:text-gray-200">&times;</button>
      </div>

      <!-- Messages -->
      <div id="messages" class="flex-1 p-4 overflow-y-auto space-y-2 text-sm bg-gray-50">
        <div class="bg-pink-100 text-black px-3 py-2 rounded-xl max-w-[80%]">Hello! How can I help you?</div>
      </div>

      <!-- Input -->
      <form id="chatForm" class="flex items-center p-2 border-t">
        <textarea id="chatInput" rows="1" placeholder="Type your message..." class="resize-none flex-1 text-sm px-3 py-2 border border-gray-300 rounded-full focus:outline-none"></textarea>
        <button type="submit" class="ml-2 text-pink-600 font-bold">âž¤</button>
      </form>
    </div>
  </div>

  <!-- JavaScript -->
  <script>
    const openBtn = document.getElementById('openChat');
    const closeBtn = document.getElementById('closeChat');
    const chatBox = document.getElementById('chatBox');
    const chatForm = document.getElementById('chatForm');
    const chatInput = document.getElementById('chatInput');
    const messages = document.getElementById('messages');

    openBtn.addEventListener('click', () => {
      chatBox.classList.toggle('hidden');
      loadHistory();
    });

    closeBtn.addEventListener('click', () => chatBox.classList.add('hidden'));

    chatForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const userMsg = chatInput.value.trim();
      if (!userMsg) return;

      appendMessage(userMsg, 'user');
      chatInput.value = '';
      scrollToBottom();

      appendTyping();

      const aiReply = await getAIResponse(userMsg);

      removeTyping();
      appendMessage(aiReply, 'ai');
      scrollToBottom();
      saveHistory();
    });

    chatInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        chatForm.dispatchEvent(new Event('submit'));
      }
    });

    function appendMessage(text, sender) {
      const className = sender === 'user' ? 'bg-gray-200 self-end text-right ml-auto' : 'bg-pink-100 text-black';
      const bubble = `<div class="${className} px-3 py-2 rounded-xl max-w-[80%] whitespace-pre-line">${text}</div>`;
      messages.insertAdjacentHTML('beforeend', bubble);
    }

    function appendTyping() {
      const bubble = `<div id="typing" class="italic text-gray-500 px-3 py-2">AI is typing...</div>`;
      messages.insertAdjacentHTML('beforeend', bubble);
    }

    function removeTyping() {
      const typing = document.getElementById('typing');
      if (typing) typing.remove();
    }

    function scrollToBottom() {
      setTimeout(() => {
        messages.scrollTop = messages.scrollHeight;
      }, 100);
    }

    function saveHistory() {
      localStorage.setItem('chatHistory', messages.innerHTML);
    }

    function loadHistory() {
      const history = localStorage.getItem('chatHistory');
      if (history) messages.innerHTML = history;
      scrollToBottom();
    }

    async function getAIResponse(message) {
      try {
        const response = await fetch("http://localhost:3000/chat", {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify({ message })
        });

        const data = await response.json();
        return data.reply || "No response from AI.";
      } catch (err) {
        console.error(err);
        return "Error talking to AI.";
      }
    }
  </script>
</body>
</html>
